<?php

namespace nicomartin\ProgressiveWordPress;

class Serviceworker {

	public $capability = '';
	public $sw_path = ABSPATH . 'sw.js';
	public $sw_url = '/sw.js';

	public function __construct() {
		$this->capability = pwp_get_instance()->Init->capability;
	}

	public function run() {
		add_action( 'admin_notices', [ $this, 'ssl_error_notice' ] );
		if ( file_exists( $this->sw_path ) ) {
			add_action( 'wp_head', [ $this, 'add_to_header' ], 1 );
		}
	}

	public function ssl_error_notice() {

		if ( is_ssl() ) {
			return;
		}

		$screen = get_current_screen();
		if ( PWP_SETTINGS_PARENT != $screen->parent_base ) {
			return;
		}

		echo '<div class="notice notice-error">';
		echo '<p>' . __( 'Your site has to be server over https to use progressive web app features.', 'pwp' ) . '</p>';
		echo '</div>';
	}

	public function regenerate() {
		$content = '/* generated by Progressive WordPress */';
		file_put_contents( $this->sw_path, $content );
	}
}
